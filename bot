#!/bin/bash

WORKSPACE=`dirname $0`
source $WORKSPACE/bot.conf

case "$1" in
  init)
    # 检查环境
    echo "checking python3..."
    sudo apt-get install python3 python3-dev python3-venv
    if [ $? != 0 ];then
      exit 1
    fi
    echo "deploying venv..."
    python3 -m venv $WORKSPACE/venv
    if [ $? != 0 ];then
      exit 1
    fi
    echo "checking requirements..."
    pip install -r $WORKSPACE/requirements.txt -q
    if [ $? != 0 ];then
      exit 1
    fi
    sed -i '/IS_INSTALLED/s/0/1/g' $WORKSPACE/bot.conf
  ;;

  start)
# 启动Bot
    if [ $IS_INSTALLED = 0 ];then
      echo "please init first"
      exit 2
    fi
    source $WORKSPACE/venv/bin/activate
    if [ $? != 0 ];then
      exit 1
    fi
    echo "OK"
    mkdir -p $WORKSPACE/logs
    python $WORKSPACE/app.py > $WORKSPACE/logs/app.log 2>&1 &
    echo "bot started"
    # 启动frp
    ($WORKSPACE/frp/frps -c $WORKSPACE/frp/frps.ini > $WORKSPACE/logs/frps.log 2>&1 &) && ($WORKSPACE/frp/frpc -c $WORKSPACE/frp/frpc.ini > $WORKSPACE/logs/frpc.log 2>&1 &)
    echo "frp started"
  ;;

  restart)
    $WORKSPACE/bot.sh stop
    $WORKSPACE/bot.sh start
  ;;

  stop)
    echo -ne "stoping bot..."
    ps -ef | grep "app.py" | grep -v "grep" | awk '{print $2}' | xargs -n1 kill > /dev/null 2>&1
    echo "OK"
    echo -ne "stoping frp..."
    ps -ef | grep "frp" | grep -v "grep" | awk '{print $2}' | xargs -n1 kill > /dev/null 2>&1
    echo "OK"
  ;;

  *)
    echo "Usage: $WORKSPACE/bot.sh {init|start|stop|restart}"
    exit 1
    ;;
esac

exit 0